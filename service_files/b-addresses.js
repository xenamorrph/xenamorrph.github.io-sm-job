"use strict";


window.mapPoints = {
  "135725": {
    "coords": [
      "55.795864",
      "37.611069"
    ],
    "options": [
      {
        "id": "135725",
        "city": "1",
        "info": {
          "image": "/i/popup-point.png",
          "metro": "<b>ВДНХ</b>",
          "address": "<b>Ул. Аргуновская, 3/2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>9:00–22:00</span></b> в будни</div>",
          "text": "<ul><li>Клиника для взрослых и детей</li><li>Масштабно: 5 этажей, 6100 кв. м</li></ul>",
        },
        "hintContent": "3-й проезд Марьиной Рощи, д.41",
        "balloonContent": "<b>3-й проезд Марьиной Рощи, д.41</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135740": {
    "coords": [
      "55.827838",
      "37.514266"
    ],
    "options": [
      {
        "id": "135740",
        "city": "1",
        "info": {
          "image": "/i/popup-point.png",
          "metro": "<b>Войковская</b>",
          "address": "<b>Ул. Клары Цеткин, д. 33 корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Тестовый текст",
        },
        "hintContent": "ул. Клары Цеткин, д. 33 корп. 28",
        "balloonContent": "<b>ул. Клары Цеткин, д. 33 корп. 28</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135741": {
    "coords": [
      "55.814614",
      "37.647603 "
    ],
    "options": [
      {
        "id": "135741",
        "city": "1",
        "info": {
          "image": "/i/popup-point.png",
          "metro": "<b>Алексеевская</b>",
          "address": "<b>Ул. Ярославская, д.4, корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Ярославская",
        },
        "hintContent": "ул. Ярославская, д.4, корп. 2",
        "balloonContent": "<b>ул. Ярославская, д.4, корп. 2</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135742": {
    "coords": [
      "55.664710",
      "37.563242 "
    ],
    "options": [
      {
        "id": "135742",
        "city": "2",
        "info": {
          "name": "ул. Новочерёмушкинская, д.65, корп.1 ",
          "image": "/i/popup-point.png",
          "metro": "<b>Кутузовская</b>",
          "address": "<b>Санкт-Петербург, Ул. Ярославская, д.4, корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Ярославская",
        },
        "hintContent": "ул. Новочерёмушкинская, д.65, корп.1 ",
        "balloonContent": "<b>ул. Новочерёмушкинская, д.65, корп.1 </b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135743": {
    "coords": [
      "55.708759",
      "37.725074 "
    ],
    "options": [
      {
        "id": "135743",
        "city": "2",
        "info": {
          "name": "Волгоградский проспект д.42, корп. 12",
          "image": "/i/popup-point.png",
          "metro": "<b>Кутузовская 2</b>",
          "address": "<b>Санкт-Петербург, Ул. Ярославская, д.4, корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Ярославская",
        },
        "hintContent": "Волгоградский проспект д.42, корп. 12",
        "balloonContent": "<b>Волгоградский проспект д.42, корп. 12</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135747": {
    "coords": [
      "55.825740",
      "37.498078"
    ],
    "options": [
      {
        "id": "135747",
        "city": "3",
        "info": {
          "name": "Старопетровский проспект д.42, корп. 12",
          "image": "/i/popup-point.png",
          "metro": "<b>Кутузовская 2</b>",
          "address": "<b>Рязань, Ул. Ярославская, д.4, корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Ярославская",
        },
        "hintContent": "Старопетровский проезд, 7А, стр. 22",
        "balloonContent": "<b>Старопетровский проезд, 7А, стр. 22</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135748": {
    "coords": [
      "55.785923",
      "37.574822"
    ],
    "options": [
      {
        "id": "135748",
        "city": "3",
        "info": {
          "name": "Старопетровский проспект д.42, корп. 12",
          "image": "/i/popup-point.png",
          "metro": "<b>Кутузовская 2</b>",
          "address": "<b>Рязань, Ул. Ярославская, д.4, корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Ярославская",
        },
        "hintContent": "Переулок Расковой, д. 14/22",
        "balloonContent": "<b>Переулок Расковой, д. 14/22</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135749": {
    "coords": [
      "55.648367",
      "37.604735 "
    ],
    "options": [
      {
        "id": "135749",
        "city": "4",
        "info": {
          "name": "Симферопольский бульвар, д.22",
          "image": "/i/popup-point.png",
          "metro": "<b>Кутузовская 2</b>",
          "address": "<b>Иваново, Ул. Ярославская, д.4, корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Ярославская",
        },
        "hintContent": "Симферопольский бульвар, д.22",
        "balloonContent": "<b>Симферопольский бульвар, д.22</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135750": {
    "coords": [
      "55.736128",
      "37.410035 "
    ],
    "options": [
      {
        "id": "135750",
        "city": "4",
        "info": {
          "name": "ул. Ярцевская, д.8",
          "image": "/i/popup-point.png",
          "metro": "<b>Кутузовская 2</b>",
          "address": "<b>Иваново, Ул. Ярославская, д.4, корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Ярославская",
        },
        "hintContent": "ул. Ярцевская, д.8",
        "balloonContent": "<b>ул. Ярцевская, д.8</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135751": {
    "coords": [
      "56.202045",
      "36.950097 "
    ],
    "options": [
      {
        "id": "135751",
        "city": "4",
        "info": {
          "name": "Иваново ул. Ярцевская, д.8",
          "image": "/i/popup-point.png",
          "metro": "<b>Кутузовская 2</b>",
          "address": "<b>Иваново, Ул. Ярославская, д.4, корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Ярославская",
        },
        "hintContent": "г. Иваново, ул. Красная, д.167",
        "balloonContent": "<b>г. Солнечногорск, ул. Красная, д.167</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135752": {
    "coords": [
      "56.176539",
      "36.998013"
    ],
    "options": [
      {
        "id": "135752",
        "city": "5",
        "info": {
          "name": "г. Солнечногорск, мкр. Рекинцо, д. 14",
          "image": "/i/popup-point.png",
          "metro": "<b>Кутузовская 2</b>",
          "address": "<b>Солнечногорск, Рекинцо Ул. Ярославская, д.4, корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Ярославская",
        },
        "hintContent": "г. Солнечногорск, мкр. Рекинцо, д. 14",
        "balloonContent": "<b>г. Солнечногорск, мкр. Рекинцо, д. 14</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135753": {
    "coords": [
      "55.816145",
      "37.512221"
    ],
    "options": [
      {
        "id": "135753",
        "city": "5",
        "info": {
          "name": "Солнечногорск ул. Космонавта Волкова д. 9/2",
          "image": "/i/popup-point.png",
          "metro": "<b>Кутузовская 2</b>",
          "address": "<b>Солнечногорск, Рекинцо Ул. Ярославская, д.4, корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Ярославская",
        },
        "hintContent": "ул. Космонавта Волкова д. 9/2",
        "balloonContent": "<b>ул. Космонавта Волкова д. 9/2</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135754": {
    "coords": [
      "55.781823",
      "37.593201"
    ],
    "options": [
      {
        "id": "135754",
        "city": "5",
        "info": {
          "name": "Солнечногорск ул. Космонавта Волкова д. 9/2",
          "image": "/i/popup-point.png",
          "metro": "<b>Кутузовская 2</b>",
          "address": "<b>Солнечногорск, Рекинцо Ул. Ярославская, д.4, корп. 2,<br> пример адреса в две строки</b>",
          "time": "<div> Часы работы: <b><span>11:00–22:00</span></b> в будни</div>",
          "text": "Ярославская",
        },
        "hintContent": "ул. Лесная, д. 57, стр. 1 ",
        "balloonContent": "<b>ул. Лесная, д. 57, стр. 1 </b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  }
};

class YandexMap {
  _elMap = {}
  _ymap = {}
  _selector = ''
  _center = []
  _zoom = 17
  _once = false

  constructor(selector, center, zoom) {
    if (!selector) return;

    this._selector = selector
    this._center = center
    this._zoom = zoom
    this._elMap = document.querySelector(selector);
    this._points = window.mapPoints;

    this._init();
    this._events();
  }

  _init() {
    this._scroll()
  }

  _events() {
    this._instance = this._scroll.bind(this)

    window.addEventListener("scroll", this._instance)
  }

  _scroll() {
    let obj = this._elMap,
      top = 0,
      winH = (window.innerHeight > 0) ? window.innerHeight : screen.height,
      scrollTop = document.documentElement.scrollTop || document.body && document.body.scrollTop || 0,
      viewPosY2 = scrollTop + winH,
      viewPosY1 = scrollTop - winH,
      self = this;

    if (this._once) return;

    if (obj.offsetParent) {
      while (true) {
        top += obj.offsetTop;
        if (!obj.offsetParent) {
          break;
        }
        obj = obj.offsetParent;
      }
    } else if (obj.y) {
      top += obj.y;
    }

    if (viewPosY2 >= top && viewPosY1 < top) {
      this._once = true
      const yaMap = () => {
        const elJs = document.createElement('script');
        elJs.type = 'text/javascript';
        elJs.src = 'https://api-maps.yandex.ru/2.1/?lang=ru_RU';
        elJs.onload = () => {
          let iterations = 20
          const interval = setInterval(() => {
            if (typeof ymaps !== 'undefined' && typeof ymaps.Map == 'function') {
              ymaps.load(() => {
                self._ymap = new ymaps.Map(self._selector.replace(/#/, ''), {
                  center: self._center,
                  zoom: self._zoom,
                })

                let leyer = self._ymap.layers.get(0).get(0)

                self._waitForTilesLoad(leyer).then(() => self._map())
              })
              clearInterval(interval);
            } else if (iterations-- === 0) {
              clearInterval(interval);
            }
          }, 100)
        }
        document.body.appendChild(elJs);
      }
      yaMap()

      window.removeEventListener("scroll", this._instance);
    }
  }

  _map() {
    // Коллекция точек Яндекс Карт
    let pointsCol = new ymaps.GeoObjectCollection()
    const bAddressesSelect = document.querySelector('.b-addresses__select select')
    const bAddressesItem = document.querySelectorAll('.b-addresses__item')
    let self = this;

    // Функция, заполняющая и вызывающая попап
    function openPopup(param) {
      document.querySelector('.js-popup-point-image img').setAttribute('src', self._points[param].options[0].info.image);
      document.querySelector('.js-popup-point-metro').innerHTML = self._points[param].options[0].info.metro;
      document.querySelector('.js-popup-point-address').innerHTML = self._points[param].options[0].info.address;
      document.querySelector('.js-popup-point-time').innerHTML = self._points[param].options[0].info.time;
      document.querySelector('.js-popup-point-text').innerHTML = self._points[param].options[0].info.text;
      window.popup.open('.popup-point');
    }

    const addPlacemark = (prop) => {
      // Создаём точку
      let pm = new ymaps.Placemark(
          self._points[prop].coords,
          self._points[prop].options
      );

      // На каждую точку вешаем событие клика, заполняем попап и вызываем его
      pm.events.add(['click'], (e) => {
          openPopup(prop)
      });

      pointsCol.add(pm);
    }

    // Функция для отрисовки точек и навешивание события клика
    for (let prop in this._points) {
      // Проверка корректности массива на наличие свойств и возможность к нему обратиться
      if (!this._points.hasOwnProperty(prop)) continue;

      // если точка не подходит к текущему выбранному городу, просто пропускаем ее и не добавяем в отрисовку
      if (parseInt(bAddressesSelect.value) !== parseInt(this._points[prop].options[0].city)) continue;

      addPlacemark(prop);
    }


    // Добавить точки на карту
    this._ymap.geoObjects.add(pointsCol);
    // Добавить подвинуть карту так, что бы в нее влезвли все точки
    this._ymap.setBounds(pointsCol.getBounds());
    this._ymap.container.fitToViewport();
    this._ymap.setZoom(this._ymap.getZoom() - 1);
    // Удалить все ненужные контролы, отвечающие за управлением картой
    this._ymap.controls.remove('searchControl');
    this._ymap.controls.remove('trafficControl');
    this._ymap.controls.remove('typeSelector');
    this._ymap.controls.remove('fullscreenControl');
    this._ymap.controls.remove('rulerControl');
    this._ymap.controls.remove('geolocationControl');


    setTimeout(() => {
      this._elMap.classList.remove('hide');
    }, 100)

    // Отрисовка точек при смене селекта
    bAddressesSelect.addEventListener('change', (e) => {
      let cityId = e.target.value

      // создаем новую коллекцию
      pointsCol = new ymaps.GeoObjectCollection()

      bAddressesItem.forEach((item) => {
        if (item.dataset.city === cityId){
          item.classList.remove('hide')
        }
        else item.classList.add('hide')

        // Удаляет все маркеры с карты
        this._ymap.geoObjects.removeAll();

        for (let prop in this._points) {
          if (!this._points.hasOwnProperty(prop)) continue;

          if(parseInt(bAddressesSelect.value) !== parseInt(this._points[prop].options[0].city)) continue;

          addPlacemark(prop);
        }
      })

      this._ymap.geoObjects.add(pointsCol);
      this._ymap.setBounds(pointsCol.getBounds());
      this._ymap.container.fitToViewport();
      this._ymap.setZoom(this._ymap.getZoom() - 1);
    })

    // Функция открытия поп-апа при нажатии на кнопку
    bAddressesItem.forEach((item) => {
      item.querySelector('.b-addresses__button').addEventListener('click', (e) => {
        let id = e.target.closest('.b-addresses__item').dataset.id;
        openPopup(id);
      })
    })
  }

  _getTileContainer(layer) {
    for (let k in layer) {
      if (layer.hasOwnProperty(k)) {
        if (
          layer[k] instanceof ymaps.layer.tileContainer.CanvasContainer
          || layer[k] instanceof ymaps.layer.tileContainer.DomContainer
        ) {
          return layer[k];
        }
      }
    }
    return null;
  }

  _waitForTilesLoad(layer) {
    const self = this;
    return new ymaps.vow.Promise(function (resolve, reject) {

      let tc = self._getTileContainer(layer),
        readyAll = true;

      tc.tiles.each(function (tile, number) {
        if (!tile.isReady()) {
          readyAll = false;
        }
      });

      if (readyAll) {
        resolve();
      } else {
        tc.events.once("ready", function () {
          resolve();
        });
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', function () {
  new YandexMap('#b-addresses', [55.753544, 37.621211], 15);

});
