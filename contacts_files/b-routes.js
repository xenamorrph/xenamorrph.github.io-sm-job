"use strict";


window.mapPoints = {
  "135725": {
    "coords": [
      "55.795864",
      "37.611069"
    ],
    "options": [
      {
        "id": "135725",
        "city": "1",
        "steps": {
          0: "Текст шага 1 Москва",
          1: "Текст шага 2 Москва",
          2: "Текст шага 3 Москва",
        },
        "info": {
          "image": '/i/b-contacts-1.jpg',
          "metro": 'ВДНХ',
          "address": 'ул. Санкт-Петербург, 3/2',
          "time": 'Пн-Пт <b>9:00–21:00</b>',
          "tel": '<a href="tel:+749970550459">+7 (499)705-50-45</a>',
          "add": 'доб. <b>1101, 4989, 1023, 4057, 1055, 4480, 1065, 4985, 4342, 1094, 1064, 1074, 1066, 7808</b>',
          "email": '<a href="mailto:h9r@smpost.r"> hr@smpost.ru</a>',
        },
        "hintContent": "3-й проезд Марьиной Рощи, д.41",
        "balloonContent": "<b>3-й проезд Марьиной Рощи, д.41</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135740": {
    "coords": [
      "55.827838",
      "37.514266"
    ],
    "options": [
      {
        "id": "135740",
        "city": "2",
        "steps": {
          0: "Текст шага 1 Питер",
          1: "Текст шага 2 Питер",
          2: "Текст шага 3 Питер",
        },
        "info": {
          "image": '/i/b-contacts-2.jpg',
          "metro": 'Метро Питер',
          "address": 'ул. Санкт-Петербург, 3/2',
          "time": 'Пн-Пт <b>10:00–21:00</b>',
          "tel": '<a href="tel:+749870550459">+7 (499)705-50-45</a>',
          "add": 'доб. <b>1101, 4989, 1023, 4057, 1055, 4480, 1065, 4985, 4342, 1094, 1064, 1074, 1066, 7808</b>',
          "email": '<a href="mailto:h8r@smpost.r"> hr@smpost.ru</a>',
        },
        "hintContent": "3-й проезд Марьиной Рощи, д.41",
        "balloonContent": "<b>3-й проезд Марьиной Рощи, д.41</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135741": {
    "coords": [
      "55.814614",
      "37.647603 "
    ],
    "options": [
      {
        "id": "135740",
        "city": "3",
        "steps": {
          0: "Текст шага 1 Рязань",
          1: "Текст шага 2 Рязань",
          2: "Текст шага 3 Рязань",
        },
        "info": {
          "image": '/i/b-contacts-1.jpg',
          "metro": 'Метро Разянь',
          "address": 'ул. Санкт-Петербург, 3/2',
          "time": 'Пн-Пт <b>67:00–21:00</b>',
          "tel": '<a href="tel:+749970550459">+7 (499)705-50-45</a>',
          "add": 'доб. <b>1101, 4989, 1023, 4057, 1055, 4480, 1065, 4985, 4342, 1094, 1064, 1074, 1066, 7808</b>',
          "email": '<a href="mailto:hr3@smpost.r"> hr@smpost.ru</a>',
        },
        "hintContent": "3-й проезд Марьиной Рощи, д.41",
        "balloonContent": "<b>3-й проезд Марьиной Рощи, д.41</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135742": {
    "coords": [
      "55.664710",
      "37.563242 "
    ],
    "options": [
      {
        "id": "135740",
        "city": "4",
        "steps": {
          0: "Текст шага 1 Иваново",
          1: "Текст шага 2 Иваново",
          2: "Текст шага 3 Иваново",
        },
        "info": {
          "image": '/i/b-contacts-1.jpg',
          "metro": 'Метро Иваново',
          "address": 'ул. Санкт-Петербург, 3/2',
          "time": 'Пн-Пт <b>08:00–21:00</b>',
          "tel": '<a href="tel:+749970550459">+7 (499)705-50-45</a>',
          "add": 'доб. <b>1101, 4989, 1023, 4057, 1055, 4480, 1065, 4985, 4342, 1094, 1064, 1074, 1066, 7808</b>',
          "email": '<a href="mailto:hpr@smpost.r"> hr@smpost.ru</a>',
        },
        "hintContent": "3-й проезд Марьиной Рощи, д.41",
        "balloonContent": "<b>3-й проезд Марьиной Рощи, д.41</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },
  "135744": {
    "coords": [
      "55.664710",
      "37.563242 "
    ],
    "options": [
      {
        "id": "135740",
        "city": "5",
        "steps": {
          0: "Текст шага 1 Солнечногорск",
          1: "Текст шага 2 Солнечногорск",
          2: "Текст шага 3 Солнечногорск",
        },
        "info": {
          "image": '/i/b-contacts-1.jpg',
          "metro": 'Метро Солнечногорск',
          "address": 'ул. Санкт-Петербург, 3/2',
          "time": 'Пн-Пт <b>08:00–21:00</b>',
          "tel": '<a href="tel:+749970550459">+7 (499)705-50-45</a>',
          "add": 'доб. <b>1101, 4989, 1023, 4057, 1055, 4480, 1065, 4985, 4342, 1094, 1064, 1074, 1066, 7808</b>',
          "email": '<a href="mailto:hr4r@smpost.r"> hr@smpost.ru</a>',
        },
        "hintContent": "3-й проезд Марьиной Рощи, д.41",
        "balloonContent": "<b>3-й проезд Марьиной Рощи, д.41</b><br>"
      },
      {
        "iconLayout": "default#image",
        "iconImageHref": "/i/geopoint.svg",
        "iconImageSize": [
          49,
          62
        ],
        "iconImageOffset": [
          -25,
          -55
        ],
        "hideIconOnBalloonOpen": false
      }
    ]
  },


};

class YandexMap {
  _elMap = {}
  _ymap = {}
  _selector = ''
  _center = []
  _zoom = 17
  _once = false

  constructor(selector, center, zoom) {
    if (!selector) return;

    this._selector = selector
    this._center = center
    this._zoom = zoom
    this._elMap = document.querySelector(selector);
    this._points = window.mapPoints;

    this._changeContent();
    this._init();
    this._events();
  }

  _init() {
    this._scroll()
  }

  _events() {
    this._instance = this._scroll.bind(this)

    window.addEventListener("scroll", this._instance)
  }

  _scroll() {
    let obj = this._elMap,
      top = 0,
      winH = (window.innerHeight > 0) ? window.innerHeight : screen.height,
      scrollTop = document.documentElement.scrollTop || document.body && document.body.scrollTop || 0,
      viewPosY2 = scrollTop + winH,
      viewPosY1 = scrollTop - winH,
      self = this;

    if (this._once) return;

    if (obj.offsetParent) {
      while (true) {
        top += obj.offsetTop;
        if (!obj.offsetParent) {
          break;
        }
        obj = obj.offsetParent;
      }
    } else if (obj.y) {
      top += obj.y;
    }

    if (viewPosY2 >= top && viewPosY1 < top) {
      this._once = true
      const yaMap = () => {
        const elJs = document.createElement('script');
        elJs.type = 'text/javascript';
        elJs.src = 'https://api-maps.yandex.ru/2.1/?lang=ru_RU';
        elJs.onload = () => {
          let iterations = 20
          const interval = setInterval(() => {
            if (typeof ymaps !== 'undefined' && typeof ymaps.Map == 'function') {
              ymaps.load(() => {
                self._ymap = new ymaps.Map(self._selector.replace(/#/, ''), {
                  center: self._center,
                  zoom: self._zoom,
                })

                let leyer = self._ymap.layers.get(0).get(0)

                self._waitForTilesLoad(leyer).then(() => self._map())
              })
              clearInterval(interval);
            } else if (iterations-- === 0) {
              clearInterval(interval);
            }
          }, 100)
        }
        document.body.appendChild(elJs);
      }
      yaMap()

      window.removeEventListener("scroll", this._instance);
    }
  }

  // Функция переключения табов и заполнения их контентом до инициализации карты
  _changeContent(){
    let self = this;

    const bContactsMetro = document.querySelector('.b-contacts__metro');
    const bContactsAddress = document.querySelector('.b-contacts__address');
    const bContactsTime = document.querySelector('.b-contacts__time');
    const bContactsTel = document.querySelector('.b-contacts__tel');
    const bContactsAdd = document.querySelector('.b-contacts__add');
    const bContactsEmail = document.querySelector('.b-contacts__email');
    const bContactsImage = document.querySelector('.b-contacts__image img');
    const bContactsToggles = document.querySelectorAll('.b-contacts__toggle');
    const bRoutesStepsText = document.querySelectorAll('.b-routes__text');

    const addContent = (prop) => {
      bRoutesStepsText.forEach((element, index)=>{
        element.innerHTML = self._points[prop].options[0].steps[index];
      })

      bContactsMetro.innerHTML = self._points[prop].options[0].info.metro;
      bContactsAddress.innerHTML = self._points[prop].options[0].info.address;
      bContactsTime.innerHTML = self._points[prop].options[0].info.time;
      bContactsTel.innerHTML = self._points[prop].options[0].info.tel;
      bContactsAdd.innerHTML = self._points[prop].options[0].info.add;
      bContactsEmail.innerHTML = self._points[prop].options[0].info.email;
      bContactsImage.setAttribute('src', self._points[prop].options[0].info.image);
    }

    bContactsToggles.forEach(toggle => {
      toggle.addEventListener('click', (e) => {
          bContactsToggles.forEach((toggle)=>{
            toggle.classList.remove('active');
          })
          e.target.classList.add('active');
          const cityId = e.target.dataset.city;

          for (let prop in this._points) {
              if (!this._points.hasOwnProperty(prop)) continue;

              // Проверяем соответствие города
              if (parseInt(cityId) === parseInt(this._points[prop].options[0].city)) {
                addContent(prop);
              }
          }
      });
    });
  }

  // Функция заполнения карты маркерами при инициализции по умолчанию
  _map() {
    let self = this;
    let pointsCol = new ymaps.GeoObjectCollection()
    const bContactsToggle = document.querySelector('.b-contacts__toggle')
    const bContactsToggles = document.querySelectorAll('.b-contacts__toggle');

    // Функция для создания точек и добавлению в коллекцию ЯК
    const addPlacemark = (prop) => {
      let pm = new ymaps.Placemark(
          self._points[prop].coords,
          self._points[prop].options
      );

      pointsCol.add(pm);
    }

    // Функция для отрисовки точек
    for (let prop in this._points) {
      // Проверка корректности массива на наличие свойств и возможность к нему обратиться
      if (!this._points.hasOwnProperty(prop)) continue;
      // Если точка не подходит к текущему выбранному городу, просто пропускаем ее и не добавяем в отрисовку
      if (parseInt(bContactsToggle.dataset.city) !== parseInt(this._points[prop].options[0].city)) continue;
      addPlacemark(prop);
    }

    // Добавить точки на карту
    this._ymap.geoObjects.add(pointsCol);
    // Добавить подвинуть карту так, что бы в нее влезвли все точки
    this._ymap.setBounds(pointsCol.getBounds());
    this._ymap.container.fitToViewport();
    this._ymap.setZoom(this._ymap.getZoom() - 10);
    // Удалить все ненужные контролы, отвечающие за управлением картой
    this._ymap.controls.remove('searchControl');
    this._ymap.controls.remove('trafficControl');
    this._ymap.controls.remove('typeSelector');
    this._ymap.controls.remove('fullscreenControl');
    this._ymap.controls.remove('rulerControl');
    this._ymap.controls.remove('geolocationControl');

    setTimeout(() => {
      this._elMap.classList.remove('hide');
    }, 100)

    // Функция заполнения карты маркерами при переключении табов
    bContactsToggles.forEach(toggle => {
      toggle.addEventListener('click', (e) => {
          const cityId = e.target.dataset.city;
          // Создаем новую коллекцию для точек
          const pointsCol = new ymaps.GeoObjectCollection();
          // Удаляем все маркеры с карты
          this._ymap.geoObjects.removeAll();

          for (let prop in this._points) {
              if (!this._points.hasOwnProperty(prop)) continue;
              // Проверяем соответствие города точке
              if (parseInt(cityId) === parseInt(this._points[prop].options[0].city)) {
                console.log(this._points[prop].options[0].city);
                // Добавляем маркер на карту
                let pm = new ymaps.Placemark(
                  self._points[prop].coords,
                  self._points[prop].options
                );
                pointsCol.add(pm);
              }
          }

          this._ymap.geoObjects.add(pointsCol); // Добавляем коллекцию точек на карту
          this._ymap.setBounds(pointsCol.getBounds()); // Устанавливаем границы карты по точкам
          this._ymap.container.fitToViewport(); // Подгоняем размер карты под размер экрана
          this._ymap.setZoom(this._ymap.getZoom() - 10); // Уменьшаем масштаб карты
      });
    });
  }

  _getTileContainer(layer) {
    for (let k in layer) {
      if (layer.hasOwnProperty(k)) {
        if (
          layer[k] instanceof ymaps.layer.tileContainer.CanvasContainer
          || layer[k] instanceof ymaps.layer.tileContainer.DomContainer
        ) {
          return layer[k];
        }
      }
    }
    return null;
  }

  _waitForTilesLoad(layer) {
    const self = this;
    return new ymaps.vow.Promise(function (resolve, reject) {

      let tc = self._getTileContainer(layer),
        readyAll = true;

      tc.tiles.each(function (tile, number) {
        if (!tile.isReady()) {
          readyAll = false;
        }
      });

      if (readyAll) {
        resolve();
      } else {
        tc.events.once("ready", function () {
          resolve();
        });
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', function () {
  new YandexMap('#b-routes', [55.753544, 37.621211], 15);

});
